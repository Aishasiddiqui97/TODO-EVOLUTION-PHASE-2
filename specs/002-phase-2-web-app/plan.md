# Implementation Plan: Phase II Multi-User Todo Web App

**Branch**: `002-phase-2-web-app` | **Date**: 2026-01-09 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-phase-2-web-app/spec.md`

## Summary

Deliver Phase II as a full-stack, multi-user todo web application with:
- authentication (sign up / sign in)
- user-specific todo CRUD (add, list, update, delete, set completion)
- strict user isolation
- persistent storage
- attractive, responsive UI

**Technical Approach**: Implement a web monorepo with a FastAPI backend (SQLModel + Postgres) and a Next.js frontend.
Authentication uses Better Auth to issue JWTs; the backend verifies JWTs and derives the current user identity from token claims.

## Technical Context

**Language/Version**:
- Backend: Python 3.13+
- Frontend: TypeScript (Next.js 16+)

**Primary Dependencies**:
- Backend: FastAPI, SQLModel
- Frontend: Next.js 16+ (App Router), Tailwind CSS

**Storage**: PostgreSQL (Neon Serverless PostgreSQL in production; Postgres-compatible in dev)

**Testing**: Not explicitly required by the Phase II spec; prioritize manual smoke tests from `quickstart.md`.

**Target Platform**:
- Backend: Linux-style web service runtime
- Frontend: modern browsers (desktop + mobile)

**Project Type**: Web application monorepo (`backend/` + `frontend/`)

**Performance Goals**:
- Interactive CRUD should feel instant to end users (no noticeable lag during normal usage)

**Constraints**:
- No AI features
- No “agent” runtime features
- No background jobs
- No future-phase features

**Scale/Scope**:
- Phase II scope only: authenticated users + basic todos

## Constitution Check

*GATE: Must pass before implementation tasks are generated. Re-check after Phase 1 design.*

### ✅ Spec-Driven Development
- Spec exists: `specs/002-phase-2-web-app/spec.md`
- This plan is derived from spec and constitution

### ✅ No Feature Invention
- Only Phase II scope: auth + basic todo CRUD + responsive UI

### ✅ Phase Boundary Enforcement
- No tags, due dates, priorities, search, filtering, collaboration, etc.
- No background workers

### ✅ Phase II Technology Standards (Stack Locks)
- Backend: FastAPI + SQLModel ✓
- Frontend: Next.js 16+ (App Router) + TypeScript + Tailwind ✓
- Database: Neon Serverless PostgreSQL ✓
- Auth: Better Auth (JWT) ✓

### ✅ User Isolation via JWT
- API derives user identity from JWT (no `user_id` in URL paths)
- All task queries are scoped by authenticated user

### ✅ Monorepo Structure
- Repository will include `frontend/` and `backend/` at root

**Gate Status**: ✅ PASSED

## Project Structure

### Documentation (this feature)

```text
specs/002-phase-2-web-app/
├── spec.md
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── api.md
└── tasks.md             # generated by /sp.tasks
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── main.py
│   ├── db.py
│   ├── models/
│   │   └── task.py
│   ├── api/
│   │   └── routes/
│   │       └── tasks.py
│   └── auth/
│       ├── jwt.py
│       └── dependencies.py
└── tests/                # optional

frontend/
├── src/
│   ├── app/
│   │   ├── (auth)/
│   │   │   ├── sign-in/page.tsx
│   │   │   └── sign-up/page.tsx
│   │   ├── todos/page.tsx
│   │   └── layout.tsx
│   ├── components/
│   ├── lib/
│   │   ├── api.ts
│   │   └── auth.ts
│   └── styles/
└── tests/                # optional

specs/
CLAUDE.md
```

**Structure Decision**: Use a monorepo with separate `backend/` and `frontend/` projects per Phase II constitution requirements.

## Complexity Tracking

*No constitution violations are required for Phase II. Keep the implementation minimal and direct.*

---

## Phase 0: Research & Technical Decisions

See: `research.md`

Key decisions adopted into this plan:
- API user identity is derived from JWT; no `user_id` segment in routes.
- Completion updates are idempotent by setting `completed: boolean`.

---

## Phase 1: Design & Contracts

### Data model

See: `data-model.md`

- Task has `user_id`, `description`, `completed`, timestamps.
- Indexes support `(user_id)` and `(user_id, completed)`.

### API contracts

See: `contracts/api.md`

Route shape:
- `/api/tasks` (GET, POST)
- `/api/tasks/{id}` (GET, PUT, DELETE)
- `/api/tasks/{id}/complete` (PATCH with explicit `completed`)

Error taxonomy:
- 400 invalid input (e.g., empty description)
- 401 unauthorized (missing/invalid token)
- 404 not found (missing resource or not owned by user)

### Backend design

Backend responsibilities:
1. Verify JWT and derive current user id.
2. Enforce user isolation by filtering all task queries by current user id.
3. Perform CRUD operations on the Task model.
4. Return consistent JSON responses and error payloads.

Key modules:
- `backend/src/main.py`: FastAPI app, router registration
- `backend/src/db.py`: engine/session setup; read `DATABASE_URL`
- `backend/src/models/task.py`: SQLModel Task model
- `backend/src/auth/jwt.py`: token verification
- `backend/src/auth/dependencies.py`: FastAPI dependency to require auth and return current user id
- `backend/src/api/routes/tasks.py`: task endpoints

### Frontend design

Frontend responsibilities:
1. Provide sign-up / sign-in pages.
2. Maintain auth state (token) and attach it to API requests.
3. Provide a responsive todo UI (list + forms + actions).
4. Handle empty/error states gracefully.

Key modules:
- `frontend/src/app/(auth)/*`: auth pages
- `frontend/src/app/todos/page.tsx`: primary todo page
- `frontend/src/lib/api.ts`: API client that attaches JWT
- `frontend/src/lib/auth.ts`: token storage + helpers
- `frontend/src/components/*`: reusable UI components

### Local development

- Use `docker-compose.yml` to run local Postgres for development.
- Backend reads `DATABASE_URL` and connects either to local Postgres or Neon.
- Secrets are provided via environment variables (never committed):
  - `DATABASE_URL`
  - `BETTER_AUTH_SECRET`

---

## Phase 2: Implementation Tasks

Implementation tasks are produced by `/sp.tasks` in `specs/002-phase-2-web-app/tasks.md`.
